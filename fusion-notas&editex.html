<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Editor Matem√°tico con Notas Flotantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bulma CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
  >
  
  <!-- MathJax Configuration -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"
    defer
  ></script>
  
  <!-- MathQuill CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css"
  />
  
  <style>
    /* Estilos para el editor matem√°tico */
    .editable:hover {
      background-color: #fffbea;
      cursor: text;
    }
    .editable[contenteditable="true"],
    .editable:focus {
      background-color: transparent !important;
      outline: none !important;
      box-shadow: none !important;
    }
    .mq-editable-field,
    .mq-editable-field .mq-root-block {
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }
    .mq-editable-field:focus {
      outline: none !important;
    }

    /* Estilos para las notas flotantes */
    .note-icon {
      display: inline-block;
      cursor: pointer;
      position: absolute;
      margin: 0;
      padding: 2px;
      user-select: none;
      z-index: 900;
      font-size: 18px;
    }
    .note-icon.dragging {
      opacity: 0.7;
      cursor: move;
      z-index: 1000;
    }
    .note-popup {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1001;
      white-space: pre-wrap;
      pointer-events: auto;
      max-width: 300px;
      border-radius: 4px;
    }

    /* Estilos para notas con contenido matem√°tico */
    .note-popup .math-field {
      display: inline-block;
      margin: 2px;
    }
    
    .note-textarea {
      position: absolute;
      z-index: 1500;
      border: 2px solid #3273dc;
      border-radius: 4px;
      padding: 8px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-family: inherit;
      resize: both;
      min-width: 200px;
      min-height: 100px;
    }

    /* Instrucciones flotantes */
    .instructions {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 2000;
      max-width: 250px;
    }

    /* Asegurar que el contenido principal no interfiera con las notas */
    .main-content {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body class="section">
  <!-- Instrucciones flotantes -->
  <div class="instructions">
    <strong>Instrucciones:</strong><br>
    ‚Ä¢ Presiona <kbd>M</kbd> para crear notas flotantes<br>
    ‚Ä¢ Arrastra üìù para mover notas<br>
    ‚Ä¢ Doble clic en üìù para editar<br>
    ‚Ä¢ En notas: <kbd>Ctrl+L</kbd> para LaTeX<br>
    ‚Ä¢ <kbd>Ctrl+L</kbd> para insertar matem√°ticas<br>
    ‚Ä¢ Clic en texto para editar teoremas
  </div>

  <div class="container content main-content">
    <h1 class="title">Editor Matem√°tico con Notas Flotantes</h1>
    
    <div class="box">
      <p class="editable"><strong>Teorema 5.5.5</strong></p>
      <p class="editable">
        Cualesquiera $n$ vectores linealmente independientes (LI)
        en un espacio vectorial $V$ de dimensi√≥n $n$
        constituyen una base para $V$.
      </p>
      <hr>
      <p class="editable"><em>Este teorema generaliza lo que sab√≠amos para:</em></p>
      <p class="editable"><strong>Teorema 5.4.7</strong></p>
      <p class="editable">
        Cualquier conjunto de $n$ vectores LI en $\mathbb{R}^n$
        genera a $\mathbb{R}^n$ y, por lo tanto, es base de $\mathbb{R}^n$.
      </p>
      <hr>
      <p class="editable"><strong>Ejemplo</strong></p>
      <p class="editable">
        Sea $H = \mathbb{R}^2$. Entonces $H$ es un subespacio de $\mathbb{R}^2$.
      </p>
    </div>

    <div class="box">
      <h2 class="subtitle">Agregar m√°s contenido</h2>
      <p class="editable">
        Puedes agregar m√°s teoremas aqu√≠. Usa $\int_0^1 x^2 dx = \frac{1}{3}$ para matem√°ticas inline.
      </p>
      <p class="editable">
        O ecuaciones m√°s complejas como $\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}$.
      </p>
    </div>
  </div>

  <!-- Dependencias JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"
  ></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ========================================
      // FUNCIONALIDAD DEL EDITOR MATEM√ÅTICO
      // ========================================
      
      const md = window.markdownit({ html: false, breaks: true, linkify: true });
      const MQ = MathQuill.getInterface(2);

      // Convierte Markdown a HTML y envuelve cada $...$ en un <span.math-field>
      function markdownToHtmlWithMath(str) {
        return md.render(str)
          .replace(/\$\s*([^$]+?)\s*\$/g, (_, tex) => {
            const cleaned = tex.replace(/\\\\/g, '\\').trim();
            return `<span class="math-field">${cleaned}</span>`;
          });
      }

      function enhanceMathField(span) {
        if (span._mqInstance) return;
        const mf = MQ.MathField(span, {
          spaceBehavesLikeTab: true,
          handlers: { edit: () => console.log('LaTeX:', mf.latex()) }
        });
        span._mqInstance = mf;

        span.addEventListener('keydown', ev => {
          const cur = mf.__controller.cursor;
          // Salir al texto previo
          if (ev.key === 'ArrowLeft' && cur.parent === cur.root && !cur.prev) {
            ev.preventDefault();
            span.blur();
            const p = span.closest('p.editable');
            p.focus();
            const prev = span.previousSibling;
            if (prev && prev.nodeType === Node.TEXT_NODE) {
              const r = document.createRange();
              r.setStart(prev, prev.textContent.length);
              r.collapse(true);
              const s = window.getSelection();
              s.removeAllRanges();
              s.addRange(r);
            }
          }
          // Salir al texto siguiente
          if (ev.key === 'ArrowRight' && cur.parent === cur.root && !cur.next) {
            ev.preventDefault();
            span.blur();
            const p = span.closest('p.editable');
            p.focus();
            const next = span.nextSibling;
            if (next && next.nodeType === Node.TEXT_NODE) {
              const r = document.createRange();
              r.setStart(next, 0);
              r.collapse(true);
              const s = window.getSelection();
              s.removeAllRanges();
              s.addRange(r);
            }
          }
        });
      }

      function initMathFields(root = document) {
        root.querySelectorAll('span.math-field').forEach(enhanceMathField);
      }

      // Procesa todos los <p.editable> al cargar para convertir $...$
      document.querySelectorAll('p.editable').forEach(p => {
        const texto = p.textContent;
        p.innerHTML = markdownToHtmlWithMath(texto);
      });

      // Inicializa edici√≥n y MathQuill
      document.querySelectorAll('p.editable').forEach(p => {
        p.contentEditable = 'false';

        // Clic para entrar en edici√≥n
        p.addEventListener('click', ev => {
          p.contentEditable = 'true';
          p.focus();
          let range;
          if (document.caretPositionFromPoint) {
            const pos = document.caretPositionFromPoint(ev.clientX, ev.clientY);
            range = document.createRange();
            range.setStart(pos.offsetNode, pos.offset);
          } else {
            range = document.caretRangeFromPoint(ev.clientX, ev.clientY);
          }
          if (range) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }
          const tgt = ev.target;
          if (tgt.classList.contains('math-field') && tgt._mqInstance) {
            tgt._mqInstance.focus();
          }
        });

        // Ctrl+L para insertar campo MathQuill
        p.addEventListener('keydown', ev => {
          if (ev.ctrlKey && ev.key.toLowerCase() === 'l') {
            ev.preventDefault();
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            range.collapse(true);
            const span = document.createElement('span');
            span.className = 'math-field';
            span.setAttribute('contenteditable', 'false');
            range.insertNode(span);
            enhanceMathField(span);
            span._mqInstance.focus();
            return;
          }
          if (ev.key === 'Enter') {
            ev.preventDefault();
            p.blur();
          }
        });

        // Pegado de Markdown
        p.addEventListener('paste', ev => {
          ev.preventDefault();
          const text = (ev.clipboardData || window.clipboardData).getData('text');
          const html = markdownToHtmlWithMath(text);
          document.execCommand('insertHTML', false, html);
          initMathFields(p);
        });

        // Al perder foco
        p.addEventListener('blur', () => {
          p.contentEditable = 'false';
          console.log('Texto editado:', p.innerHTML);
        }, true);
      });

      // Inicializa MathQuill en los spans creados
      initMathFields();

      // ========================================
      // FUNCIONALIDAD DE NOTAS FLOTANTES
      // ========================================

      // Variables globales para las notas
      let activePopup = null;
      let activeIcon = null;

      // Crear nota con tecla 'M'
      document.addEventListener('keydown', function(e) {
        // Solo crear nota si no estamos editando texto matem√°tico
        if (e.key.toLowerCase() === 'm' && !e.repeat && !e.ctrlKey) {
          // Verificar si estamos en un campo editable
          const activeElement = document.activeElement;
          if (activeElement && (
            activeElement.contentEditable === 'true' || 
            activeElement.tagName === 'TEXTAREA' ||
            activeElement.tagName === 'INPUT' ||
            activeElement.classList.contains('mq-editable-field')
          )) {
            return; // No crear nota si estamos editando
          }
          
          e.preventDefault();
          const x = e.clientX + window.scrollX;
          const y = e.clientY + window.scrollY;
          createTextarea(x, y, null);
        }
      });

      function createTextarea(x, y, icon) {
        const textarea = document.createElement('div');
        textarea.contentEditable = 'true';
        textarea.className = 'note-textarea';
        textarea.style.left = x + 'px';
        textarea.style.top = y + 'px';
        
        if (icon) {
          // Si es edici√≥n, restaurar el contenido HTML procesado
          textarea.innerHTML = processNoteContent(icon.dataset.content);
          initMathFields(textarea);
        } else {
          textarea.innerHTML = '<p>Escribe tu nota aqu√≠...</p>';
        }
        
        document.body.appendChild(textarea);
        textarea.focus();

        // Agregar funcionalidad de LaTeX con Ctrl+L
        textarea.addEventListener('keydown', (ev) => {
          if (ev.ctrlKey && ev.key.toLowerCase() === 'l') {
            ev.preventDefault();
            ev.stopPropagation();
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            range.deleteContents(); // Eliminar cualquier selecci√≥n existente
            const span = document.createElement('span');
            span.className = 'math-field';
            span.setAttribute('contenteditable', 'false');
            range.insertNode(span);
            range.setStartAfter(span);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            enhanceMathField(span);
            setTimeout(() => {
              span._mqInstance.focus();
            }, 10);
            return;
          }
          if (ev.key === 'Escape') {
            ev.preventDefault();
            ev.stopPropagation();
            document.body.removeChild(textarea);
            return;
          }
        });

        textarea.addEventListener('blur', (ev) => {
          // No cerrar si el foco va a un campo matem√°tico dentro de la nota
          if (ev.relatedTarget && ev.relatedTarget.closest('.note-textarea')) {
            return;
          }
          
          const content = textarea.innerHTML.trim();
          document.body.removeChild(textarea);
          if (content && content !== '<p>Escribe tu nota aqu√≠...</p>') {
            if (icon) {
              icon.dataset.content = content;
              hidePopup();
              showPopup(icon);
            } else {
              addNoteIcon(x, y, content);
            }
          }
        });
      }

      // Funci√≥n para procesar contenido de notas con LaTeX
      function processNoteContent(content) {
        // Si el contenido ya tiene HTML (con math-field), devolverlo tal como est√°
        if (content.includes('math-field')) {
          return content;
        }
        // Si es texto plano, procesarlo para convertir $...$ en math-field
        return content.replace(/\$\s*([^$]+?)\s*\$/g, (_, tex) => {
          const cleaned = tex.replace(/\\\\/g, '\\').trim();
          return `<span class="math-field">${cleaned}</span>`;
        });
      }

      function addNoteIcon(x, y, content) {
        const icon = document.createElement('span');
        icon.textContent = 'üìù';
        icon.className = 'note-icon';
        icon.dataset.content = content;
        icon.style.left = x + 'px';
        icon.style.top = y + 'px';
        icon.title = 'Doble clic para editar, arrastra para mover';
        document.body.appendChild(icon);
        addDragHandlers(icon);
        addHoverHandlers(icon);
        icon.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          hidePopup();
          createTextarea(parseInt(icon.style.left), parseInt(icon.style.top), icon);
        });
      }

      function showPopup(icon) {
        hidePopup();
        const popup = document.createElement('div');
        popup.className = 'note-popup';
        
        // Procesar el contenido para mostrar LaTeX renderizado
        const processedContent = processNoteContent(icon.dataset.content);
        popup.innerHTML = processedContent;
        
        // Inicializar campos matem√°ticos en el popup
        initMathFields(popup);
        
        const rect = icon.getBoundingClientRect();
        popup.style.left = rect.left + window.scrollX + 'px';
        popup.style.top = rect.bottom + window.scrollY + 5 + 'px';
        document.body.appendChild(popup);
        activePopup = popup;
        activeIcon = icon;
        
        popup.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!popup.matches(':hover') && !icon.matches(':hover')) {
              hidePopup();
            }
          }, 100);
        });
      }

      function hidePopup() {
        if (activePopup) {
          activePopup.remove();
          activePopup = null;
          activeIcon = null;
        }
      }

      function addHoverHandlers(icon) {
        icon.addEventListener('mouseenter', () => showPopup(icon));
        icon.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!activePopup || (!activePopup.matches(':hover') && !icon.matches(':hover'))) {
              hidePopup();
            }
          }, 100);
        });
      }

      function addDragHandlers(icon) {
        let offsetX = 0, offsetY = 0;
        let isDragging = false;
        
        function onMouseDown(e) {
          e.preventDefault();
          e.stopPropagation();
          isDragging = false;
          offsetX = e.clientX - icon.getBoundingClientRect().left;
          offsetY = e.clientY - icon.getBoundingClientRect().top;
          
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        }
        
        function onMouseMove(e) {
          e.preventDefault();
          if (!isDragging) {
            isDragging = true;
            icon.classList.add('dragging');
            hidePopup();
          }
          const x = e.clientX - offsetX + window.scrollX;
          const y = e.clientY - offsetY + window.scrollY;
          icon.style.left = x + 'px';
          icon.style.top = y + 'px';
        }
        
        function onMouseUp(e) {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          icon.classList.remove('dragging');
          
          // Eliminar si se arrastra fuera de la pantalla (arriba)
          const rect = icon.getBoundingClientRect();
          if (rect.top < 0) {
            icon.remove();
            hidePopup();
          }
          
          isDragging = false;
        }
        
        icon.addEventListener('mousedown', onMouseDown);
      }

      // Limpiar notas que salen de la pantalla al hacer scroll
      window.addEventListener('scroll', () => {
        document.querySelectorAll('.note-icon').forEach(icon => {
          const rect = icon.getBoundingClientRect();
          if (rect.top < -50) { // Margen de tolerancia
            icon.remove();
            if (activeIcon === icon) {
              hidePopup();
            }
          }
        });
      });

      // Ocultar popup al hacer clic en cualquier lugar
      document.addEventListener('click', (e) => {
        if (!e.target.classList.contains('note-icon') && 
            !e.target.classList.contains('note-popup')) {
          hidePopup();
        }
      });

      console.log('Sistema completo inicializado: Editor matem√°tico + Notas flotantes');
    });
  </script>
</body>
</html>
